---
order: 2
star: 3
icon: sort
date: 2024-07-24
pageInfo: ['Author','PageView']

category:
  - SAP
tag:
  - ABAP

permalink: /sap/abap/ftp.html

---

:::tip
FTP服务器
:::

目标:已有FTP服务器IP和账号密码，通过sap与服务器连接，下载对应的文件并下载至PC并在浏览器显示内容。
- 连接服务器还可以用webservice方式。
- pdf档案可以转换成字符串传输到其它系统(ps:没试过)
xstring字节流？
- sm30维护SAPFTP_SERVERS_V配置表
- 连接ftp服务器可能还需要VPN，测试和正式不一样(寻求basis帮忙配置):balloon:。
<!-- 摘要截止标签 -->
<!-- more -->

# FTP服务器连接


## 代码
```abap
 CASE P_UCOMM.
    WHEN '&IC1'.
          CASE RS_SELFIELD-FIELDNAME.
        WHEN 'ZPDF'.
          LV_USER = ''."账号
          LV_PWD  = ''."密码
          LV_HSOT = ''."此处是IP
          LV_SLEN  = STRLEN( LV_PWD ).

          READ TABLE GT_DATA INTO GS_DATA INDEX RS_SELFIELD-TABINDEX.
          IF GS_DATA-ZPDF IS NOT INITIAL.

            LV_COMMAND =  GS_DATA-ZPDF.

            CALL FUNCTION 'HTTP_SCRAMBLE'
              EXPORTING
                SOURCE      = LV_PWD
                SOURCELEN   = LV_SLEN
                KEY         = KEY
              IMPORTING
                DESTINATION = LV_PWD.
***打开 FTP 服务器
            CALL FUNCTION 'FTP_CONNECT'
              EXPORTING
                USER            = LV_USER
                PASSWORD        = LV_PWD
                HOST            = LV_HSOT
                RFC_DESTINATION = 'SAPFTPA'
              IMPORTING
                HANDLE          = EV_HANDLE
              EXCEPTIONS
                NOT_CONNECTED   = 1
                OTHERS          = 2.

            IF  SY-SUBRC NE 0 .
              MESSAGE 'FTP连接失败，请联系IT部门' TYPE 'E' .
            ENDIF.

***获取FTP 指定目录文件名称
            LV_SLEN = STRLEN( LV_COMMAND ).

            CALL FUNCTION 'FTP_COMMAND'
              EXPORTING
                HANDLE        = EV_HANDLE
                COMMAND       = 'set passive on'
              TABLES
                DATA          = LT_RESULT
              EXCEPTIONS
                COMMAND_ERROR = 1
                TCPIP_ERROR   = 2.
            CLEAR LT_RESULT[].

            CONCATENATE 'nlist' '/SDM/2023-06-15' INTO LV_COMMAND1 SEPARATED BY SPACE.
***好像是查看该目录下的文件
            CALL FUNCTION 'FTP_COMMAND'
              EXPORTING
                HANDLE        = EV_HANDLE
                COMMAND       = LV_COMMAND1
              TABLES
                DATA          = LT_RESULT
              EXCEPTIONS
                TCPIP_ERROR   = 1
                COMMAND_ERROR = 2
                DATA_ERROR    = 3.
            CLEAR LT_RESULT[].

            CLEAR P_STATUS.
***DE目录是否存在检查
            CALL FUNCTION 'WS_QUERY'
              EXPORTING
                FILENAME       = '/SDM'
                QUERY          = 'DE'
              IMPORTING
                RETURN         = P_STATUS
              EXCEPTIONS
                INV_QUERY      = 1
                NO_BATCH       = 2
                FRONTEND_ERROR = 3
                OTHERS         = 4.
***如果不存在，目录创建
            IF P_STATUS = 0.
              CALL FUNCTION 'GUI_CREATE_DIRECTORY'
                EXPORTING
                  DIRNAME = '/SDM'
                EXCEPTIONS
                  FAILED  = 1
                  OTHERS  = 2.
            ENDIF.
            CLEAR P_STATUS.

            SELECT SINGLE * INTO @DATA(LS_002) FROM ZFIR002 WHERE BELNR  = @GS_DATA-BELNR.
            IF SY-SUBRC = 0.
              LS_002-BUDAT = LS_002-BUDAT + 1.
              P_FILENAME = '/SDM/' && LS_002-BUDAT+0(4) && '-' && LS_002-BUDAT+4(2) && '-' &&
                             LS_002-BUDAT+6(2).
            ENDIF.

            CALL FUNCTION 'WS_QUERY'
              EXPORTING
                FILENAME       = P_FILENAME
                QUERY          = 'DE'
              IMPORTING
                RETURN         = P_STATUS
              EXCEPTIONS
                INV_QUERY      = 1
                NO_BATCH       = 2
                FRONTEND_ERROR = 3
                OTHERS         = 4.

            IF P_STATUS = 0.
              P_DIRNAME = P_FILENAME.
              CALL FUNCTION 'GUI_CREATE_DIRECTORY'
                EXPORTING
                  DIRNAME = P_DIRNAME
                EXCEPTIONS
                  FAILED  = 1
                  OTHERS  = 2.
            ENDIF.
            CLEAR P_STATUS.

*          lv_command = '/SDM/2023-06-15/20230606_20701010006_3844645_2.pdf'.
            CLEAR BLOB[].

***从FTP将文件读取到内表
            CALL FUNCTION 'FTP_SERVER_TO_R3'
              EXPORTING
                HANDLE      = EV_HANDLE
                FNAME       = LV_COMMAND
              IMPORTING
                BLOB_LENGTH = BLOB_LENGTH
              TABLES
                BLOB        = BLOB.
            LV_COMMAND2 = LV_COMMAND.
***将内部表格下载到PC
            CALL FUNCTION 'GUI_DOWNLOAD'
              EXPORTING
                FILENAME = LV_COMMAND2
                FILETYPE = 'BIN'
              TABLES
                DATA_TAB = BLOB.
***断开与FTP服务器的连接
            CALL FUNCTION 'FTP_DISCONNECT'
              EXPORTING
                HANDLE = EV_HANDLE.
***关闭打开的RFC会话
            CALL FUNCTION 'RFC_CONNECTION_CLOSE'
              EXPORTING
                DESTINATION = 'SAPFTP'
              EXCEPTIONS
                OTHERS      = 1.
***跳转到网页
            CALL METHOD CL_GUI_FRONTEND_SERVICES=>EXECUTE
              EXPORTING
                APPLICATION = LV_COMMAND2.
          ENDIF.
        WHEN OTHERS.
      ENDCASE.
```

<!-- <Catalog base='/' hideHeading/> -->

