---
order: 15
# star: 3
# icon: sort
date: 2024-10-17
pageInfo: ['Author','PageView']

category:
  - SAP
tag:
  - ABAP
  - BASIS


permalink: /sap/abap/mail.html

---


# 邮件
<!-- more -->
邮件邮件

## 导入步骤
https://blog.csdn.net/woniu_maggie/article/details/141561991


## 遇到的问题
1. 因为网络问题导致一直出现连接SMTP节点连接不上
邮箱地址用户端网页可以登录，但sap就是连接不上，首先确认url和端口是否正确，然后确认用户是否正常密码是否修改。url可以ping通， 加上端口就不行，最后确定是网络的策略使端口不通。
用户是前端进的，sap连是后端连的，方式不一样
![alt text](image-40.png)

2. 最近进行邮箱地址的迁移改成了QQ邮箱(mail.a123systems.com->smtp.exmail.qq.com)，不知道为啥smtp.exmail.qq.com 25端口成功，465端口(SSL)加密端口就不行
![alt text](image-41.png)

3. 501 mail from address must be same as authorization user 
发送邮件的用户的电子邮件地址(标准号码)设置必须和节点地址相同，当然用户电子邮件地址可以维护多个

## 事务代码
SICF 
SPROXY
SMICM
RZ10
SBWP
SCOT
SOST

## ABAP测试程序
<!-- <details>
  <summary>点击展开/折叠代码</summary>
  ```javascript
  console.log("这是一个可折叠的代码块");
  console.log("这是一个可折叠的代码块");
  console.log("这是一个可折叠的代码块");
  console.log("这是一个可折叠的代码块");
   ```
  </details>  -->
 
### SMARTFORMS获取pdf发送邮件

<!-- <details>
  <summary>点击展开/折叠代码:SMARTFORMS获取pdf发送邮件</summary> -->
```ABAP:SMARTFORMS获取pdf发送邮件
*&---------------------------------------------------------------------*
*& Report ZTEST_036
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT ZTEST_036.
DATA: FM_NAME      TYPE RS38L_FNAM.
DATA: GWA_RESULT  TYPE SSFCRESCL,
      GWA_OUTPUT  TYPE SSFCOMPOP,
      GWA_CONTROL TYPE SSFCTRLOP.
*DATA: LS_HEAD TYPE ZMMS010, "定义表头内表
*      LT_ITEM TYPE TABLE OF ZMMS010 WITH HEADER LINE. "定义表值内表
DATA: GV_SIZE       TYPE I.
DATA: GZ_LINES      TYPE TABLE OF TLINE.
DATA: GS_LINES      TYPE SOLIX_TAB .
DATA:LV_XSTRING     TYPE XSTRING.                 "pdf附件
DATA: LO_BCS        TYPE REF TO CL_BCS,
      LO_DOC_BCS    TYPE REF TO CL_DOCUMENT_BCS,
      L_SENDER      TYPE REF TO CL_SAPUSER_BCS,
      L_SEND_RESULT TYPE OS_BOOLEAN,
      L_SUBJECT     TYPE SO_OBJ_DES.



DATA: LO_RECIPIENT   TYPE REF TO IF_RECIPIENT_BCS. "收件人
DATA: L_TO TYPE ADR6-SMTP_ADDR."收件人地址
DATA: L_FILE_SIZE_CHAR TYPE SO_OBJ_LEN.

DATA: LT_SOLISTI1 TYPE  SOLI_TAB ,         "定义邮件内容
      LS_SOLISTI1 TYPE SOLI.
DATA : LO_MIME_HELPER    TYPE REF TO CL_GBT_MULTIRELATED_SERVICE.

CREATE OBJECT LO_DOC_BCS.
* 邮件标题
L_SUBJECT = '邮件标题'.


* 邮件正文
LS_SOLISTI1 = '<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xfa="http://www.xfa.org/schema/xfa-template/2.1/"> <head> <meta http-equiv = "Content-Type" content = "text/html; charset = utf-8"></head>'.
APPEND LS_SOLISTI1 TO LT_SOLISTI1.
LS_SOLISTI1 = '<BODY>'.
APPEND LS_SOLISTI1 TO LT_SOLISTI1.
CLEAR LS_SOLISTI1.
LS_SOLISTI1  = '<SPAN style="font-family:Calibri;font-size:小四;">'.
APPEND LS_SOLISTI1 TO LT_SOLISTI1.
CONCATENATE  '备注:'  '<BR><BR>' INTO LS_SOLISTI1.
APPEND LS_SOLISTI1 TO LT_SOLISTI1.
CONCATENATE  '重要提示：此邮件及附件具有保密性质，包含商业秘密，受法律保护不得泄露.'  '<BR><BR>' INTO LS_SOLISTI1.
APPEND LS_SOLISTI1 TO LT_SOLISTI1.
CLEAR LS_SOLISTI1.
LS_SOLISTI1 ='</SPAN>'.
APPEND LS_SOLISTI1 TO LT_SOLISTI1.


*CREATE THE DOCUMENT WITH CONTENTS
CREATE OBJECT LO_MIME_HELPER.
CALL METHOD LO_MIME_HELPER->SET_MAIN_HTML
  EXPORTING
    CONTENT     = LT_SOLISTI1
    DESCRIPTION = 'Automatic payment'.  "title


LO_DOC_BCS = CL_DOCUMENT_BCS=>CREATE_FROM_MULTIRELATED( I_SUBJECT = L_SUBJECT I_MULTIREL_SERVICE = LO_MIME_HELPER I_LANGUAGE = SY-LANGU I_IMPORTANCE = '1' ).


"附件PDF参数
GWA_CONTROL-NO_DIALOG = 'X'.
GWA_CONTROL-NO_CLOSE = ' '.
GWA_CONTROL-PREVIEW = ' '.
GWA_CONTROL-GETOTF = 'X'.
GWA_CONTROL-LANGU     = SY-LANGU.
GWA_OUTPUT-TDNEWID   = 'X'.
GWA_OUTPUT-TDIMMED   = 'X'.
GWA_OUTPUT-TDDELETE   = 'X'.
GWA_OUTPUT-TDDEST  = 'LP01'.


"调用smartforms
CALL FUNCTION 'SSF_FUNCTION_MODULE_NAME'
  EXPORTING
*    FORMNAME           = 'ZMMF001'
    FORMNAME           = 'ZTEST01'
*   VARIANT            = ' '
*   DIRECT_CALL        = ' '
  IMPORTING
    FM_NAME            = FM_NAME
  EXCEPTIONS
    NO_FORM            = 1
    NO_FUNCTION_MODULE = 2
    OTHERS             = 3.
IF SY-SUBRC <> 0.
* Implement suitable error handling here
ENDIF.



"smartforms数据处理
*DATA: LS_HEAD TYPE ZMMS016,
*      LS_ITEM TYPE ZMMS016,
*      LT_ITEM TYPE TABLE OF ZMMS016.
*LS_HEAD-EBELN = '4100000206'.
*LS_ITEM-EBELN = '4100000206'.
*LS_ITEM-BUTXT = 'SDF'.
*APPEND LS_ITEM TO LT_ITEM[].

CALL FUNCTION FM_NAME
  EXPORTING
    CONTROL_PARAMETERS = GWA_CONTROL
    OUTPUT_OPTIONS     = GWA_OUTPUT
    USER_SETTINGS      = ''
*    LS_HEAD            = LS_HEAD
  IMPORTING
    JOB_OUTPUT_INFO    = GWA_RESULT
*  TABLES
*    LT_ITEM            = LT_ITEM[] ""传值进入smartforms
  EXCEPTIONS
    FORMATTING_ERROR   = 1
    INTERNAL_ERROR     = 2
    SEND_ERROR         = 3
    USER_CANCELED      = 4
    OTHERS             = 5.
IF SY-SUBRC <> 0.
* Implement suitable error handling here
ENDIF.


*Convert OTF to PDF
CALL FUNCTION 'CONVERT_OTF'
  EXPORTING
    FORMAT                = 'PDF'
  IMPORTING
    BIN_FILESIZE          = GV_SIZE
    BIN_FILE              = LV_XSTRING
  TABLES
    OTF                   = GWA_RESULT-OTFDATA
    LINES                 = GZ_LINES
  EXCEPTIONS
    ERR_MAX_LINEWIDTH     = 1
    ERR_FORMAT            = 2
    ERR_CONV_NOT_POSSIBLE = 3
    ERR_BAD_OTF           = 4
    OTHERS                = 5.

IF SY-SUBRC <> 0.
  MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
          WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

"转换二进制
CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
  EXPORTING
    BUFFER     = LV_XSTRING
  TABLES
    BINARY_TAB = GS_LINES.

*     附件长度
L_FILE_SIZE_CHAR = GV_SIZE.

*     添加附件,可以添加多个附件
CALL METHOD LO_DOC_BCS->ADD_ATTACHMENT
  EXPORTING
    I_ATTACHMENT_TYPE    = 'BIN'
*    I_ATTACHMENT_SUBJECT = 'PO' && LS_HEAD-EBELN && '.PDF'
    I_ATTACHMENT_SUBJECT = '啊啊啊' && '烦死了' && '.PDF'
    I_ATTACHMENT_SIZE    = L_FILE_SIZE_CHAR
    I_ATT_CONTENT_HEX    = GS_LINES.



LO_BCS = CL_BCS=>CREATE_PERSISTENT( ).
L_SENDER = CL_SAPUSER_BCS=>CREATE( SY-UNAME ).


CALL METHOD LO_BCS->SET_SENDER
  EXPORTING
    I_SENDER = L_SENDER.


DATA:LF_ERROR TYPE REF TO CX_ADDRESS_BCS.

"设置接收人\抄送人邮箱
*IF GX_ZMMF010-ZZEMAIL IS NOT INITIAL.
TRY.
*    L_TO = 'bin.xu@a123systems.com'."邮箱地址
    L_TO = '504077806@qq.com'."邮箱地址
*    L_TO = 'chu.gao@a123systems.com'."邮箱地址
    LO_RECIPIENT = CL_CAM_ADDRESS_BCS=>CREATE_INTERNET_ADDRESS( L_TO ).
    LO_BCS->ADD_RECIPIENT( I_RECIPIENT  = LO_RECIPIENT
                           I_EXPRESS    = 'X'
                           I_COPY       = ' '"设置是否抄送
                           I_BLIND_COPY = ' '
                           I_NO_FORWARD = ' ' ).

  CATCH   CX_ADDRESS_BCS INTO LF_ERROR .
    MESSAGE '邮件地址异常!' TYPE 'I'.
    RETURN.
ENDTRY.

*ENDIF.


"提交邮件发送申请
LO_BCS->SET_DOCUMENT( I_DOCUMENT = LO_DOC_BCS ).
CALL METHOD LO_BCS->SEND(
  EXPORTING
    I_WITH_ERROR_SCREEN = 'X'
  RECEIVING
    RESULT              = L_SEND_RESULT
).

IF L_SEND_RESULT = 'X'.
  COMMIT WORK AND WAIT.
  MESSAGE '邮件发送成功' TYPE 'S'.
*  CLEAR LS_MODIFY_EMAIL.
ELSE.
  ROLLBACK WORK.
  MESSAGE '邮件发送失败' TYPE  'E'.
ENDIF.



WAIT UP TO 2 SECONDS.

SUBMIT RSCONN01 WITH MODE = 'INT'
        WITH OUTPUT = 'X'
        AND RETURN.
```

### 邮件测试手工编写EXCEL
``` ABAP  邮件测试手工编写EXCEL
*&---------------------------------------------------------------------*
*& Report ZTEST_003
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT ZTEST_003.


TYPES: BEGIN OF TY_MRTAB,
         MATNR TYPE MARA-MATNR,
         MAKTX TYPE MAKT-MAKTX,
         MTART TYPE MARA-MTART,
       END OF TY_MRTAB.
FIELD-SYMBOLS: <GT_TABLE> TYPE TABLE.         "DYNAMIC TABLE INDICATE
" 容器字段
FIELD-SYMBOLS: <FS_DATA>      TYPE ANY,
               <FS_CELL_DATA> TYPE ANY.
DATA: LR_DATA            TYPE REF TO DATA,
      LO_DESCR           TYPE REF TO CL_ABAP_TYPEDESCR,
      LO_STR_DESCR_IN    TYPE REF TO CL_ABAP_STRUCTDESCR,
      LS_ABAP_COMP_DESCR TYPE ABAP_COMPDESCR.

"附件参数
DATA: LT_OTF    TYPE TABLE OF ITCOO,
      LT_TLINE  TYPE TABLE OF TLINE,
      LT_RECORD TYPE TABLE OF SOLISTI1,
      LS_OTF    TYPE ITCOO,
      LS_TLINE  TYPE TLINE,
      LS_RECORD TYPE SOLISTI1.
"邮件参数
DATA: LV_SIZE      TYPE I, "邮件附件大小
      LV_LINES_TXT TYPE I, "邮件文本行数
      LV_LINES_BIN TYPE I, "邮件附件行数
      LV_BENFILE   TYPE XSTRING,
      LV_OBJECT    TYPE CHAR50, "邮件主题
      LV_FILENAME  TYPE CHAR50,
      LT_OBJPACK   TYPE TABLE OF SOPCKLSTI1 , "邮件内容 正文+附件
      LT_OBJTXT    TYPE TABLE OF SOLISTI1   , "正文内容
      LT_OBJBIN    TYPE TABLE OF SOLISTI1   , "附件内容
      LT_RECLIST   TYPE TABLE OF SOMLRECI1  , "收件人
      LS_DOC_CHNG  TYPE SODOCCHGI1, "邮件属性
      LS_OBJPACK   TYPE SOPCKLSTI1,
      LS_OBJTXT    TYPE SOLISTI1,
      LS_OBJBIN    TYPE SOLISTI1,
      LS_RECLIST   TYPE SOMLRECI1.

DATA: LV_STR  TYPE STRING,
      LV_CELL TYPE STRING.
DATA ZTEXT TYPE CHAR255.

* 需要转excel的内表
DATA: LT_DATA TYPE TABLE OF TY_MRTAB.
LT_DATA = VALUE #( ( MATNR = '100' MAKTX = '硅粉621，纯度≥99.1%，P＜80ppm；B＜50ppm' MTART = '1000' )
                   ( MATNR = '200' MAKTX = '硅粉621，纯度≥99.1%，P＜80ppm；B＜50ppm' MTART = '1000' ) ).

" 转动态内表以符合各种场景
ASSIGN LT_DATA TO <GT_TABLE>.

*&--获取lt_data的表结构
CREATE DATA LR_DATA LIKE LINE OF <GT_TABLE>.
ASSIGN LR_DATA->* TO <FS_DATA>.

" EXCEL表头
*  LOOP AT gt_fieldcat_alv INTO DATA(ls_fieldcat_alv).
*    " 单元格 + TAB符
*    lv_str = lv_str && ls_fieldcat_alv-seltext_l && cl_abap_char_utilities=>horizontal_tab.
*  ENDLOOP.
*  " 最后使用回车符换行
*  lv_str = lv_str && cl_abap_char_utilities=>cr_lf.

*&--获取内表列字段
CALL METHOD CL_ABAP_STRUCTDESCR=>DESCRIBE_BY_DATA
  EXPORTING
    P_DATA      = <FS_DATA>
  RECEIVING
    P_DESCR_REF = LO_DESCR.

LO_STR_DESCR_IN ?= LO_DESCR.

*&--EXCEL表体
LOOP AT <GT_TABLE> ASSIGNING <FS_DATA>.
*    CLEAR: lv_str,lv_start,lv_end.

  " 循环每行的每个单元格
  LOOP AT LO_STR_DESCR_IN->COMPONENTS INTO LS_ABAP_COMP_DESCR.

    " 根据字段名找到字段
    ASSIGN COMPONENT LS_ABAP_COMP_DESCR-NAME OF STRUCTURE <FS_DATA> TO <FS_CELL_DATA>.

    " 去除首尾引号，否则xls文件中tab符会有问题
    LV_CELL = <FS_CELL_DATA>.
    REPLACE ALL OCCURRENCES OF REGEX '^"*|"*$' IN LV_CELL WITH ''.

    " 单元格 + TAB符
    LV_STR = LV_STR && LV_CELL && CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.

  ENDLOOP.

  " 最后使用回车符换行
  LV_STR = LV_STR && CL_ABAP_CHAR_UTILITIES=>CR_LF.

ENDLOOP.

"string类型-> XSTRING
CALL FUNCTION 'SCMS_STRING_TO_XSTRING'
  EXPORTING
    TEXT     = LV_STR
*   mimetype = 'XLS'
    ENCODING = '8404' "防止中文乱码
  IMPORTING
    BUFFER   = LV_BENFILE
  EXCEPTIONS
    FAILED   = 1
    OTHERS   = 2.

IF LV_BENFILE IS NOT INITIAL.
  CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
    EXPORTING
      BUFFER        = LV_BENFILE
    IMPORTING
      OUTPUT_LENGTH = LV_SIZE
    TABLES
      BINARY_TAB    = LT_RECORD.
ENDIF.

"将转换后的文件添加到邮件附件
APPEND LINES OF LT_RECORD TO LT_OBJBIN.

*  &---邮件处理


TYPES : BEGIN OF TY_DATA,
          MANDT     TYPE MANDT,
          BNAME     TYPE   XUBNAME,    "用户名
          SMTP_ADDR TYPE AD_SMTPADR.   "
TYPES : END OF TY_DATA.
DATA LT_RECEIVER TYPE TABLE OF TY_DATA.
*LT_RECEIVER = VALUE #( ( MANDT = '300' BNAME = 'XUBIN' smtp_addr = 'bin.xu@a123systems.com' ) ).
LT_RECEIVER = VALUE #( ( SMTP_ADDR = 'bin.xu@a123systems.com' ) ).
*LT_RECEIVER = VALUE #( ( SMTP_ADDR = 'qiaoqiao.zhang@a123systems.com' ) ).
*LT_RECEIVER = VALUE #( ( smtp_addr = 'longzhu.duan@a123systems.com' ) ).
*LT_RECEIVER = VALUE #( ( smtp_addr = '504077806@qq.com' ) ).
*  " 获取收件人
*  SELECT DISTINCT
*    smtp_addr
*  FROM zmmt045
*  INTO TABLE @DATA(lt_receiver).
LV_SIZE = LINES( LT_OBJBIN ) * 255.

"添加邮件正文
LS_OBJTXT = 'ZMMR011报表已导出，请查看附件'. "
APPEND LS_OBJTXT TO LT_OBJTXT.

LS_OBJTXT = '-------------------------------------------'. "
APPEND LS_OBJTXT TO LT_OBJTXT.


CLEAR ZTEXT.
ZTEXT = 'Created in—' && SY-MANDT && ' by buser- ' && SY-UNAME.
LS_OBJTXT = ZTEXT.
APPEND LS_OBJTXT TO LT_OBJTXT.

CLEAR ZTEXT.
ZTEXT = '日期 ' && SY-DATUM && ' 时间 ' && SY-UZEIT.
LS_OBJTXT = ZTEXT. "
APPEND LS_OBJTXT TO LT_OBJTXT.

"邮件正文行数
LV_LINES_TXT = LINES( LT_OBJTXT ).
LV_OBJECT = 'ZMMR011导出'. " 标题：ZMMR011报表
LV_FILENAME = 'ZMMR011.XLS'.  " 附件XLS命名
*LV_FILENAME = 'ZMMR011.XLSX'.  " 附件XLS命名
LS_DOC_CHNG-OBJ_LANGU = SY-LANGU.
LS_DOC_CHNG-OBJ_NAME = 'Email'.  " Email
*        ls_doc_chng-expiry_dat = sy-datum + 10.  " 邮件过期日，在此日期后邮件将无法被查看
LS_DOC_CHNG-OBJ_DESCR = LV_OBJECT.  "邮件标题
*        ls_doc_chng-sensitivty = 'F'.  " 邮件保密等级
LS_DOC_CHNG-DOC_SIZE = LV_LINES_TXT * 255 + LV_SIZE.
LS_DOC_CHNG-PRIORITY = '3'. " 1：低优先级 3：普通优先级 5：高优先级

CLEAR LS_OBJPACK-TRANSF_BIN.
LS_OBJPACK-HEAD_START = 1.
LS_OBJPACK-HEAD_NUM = 0.
LS_OBJPACK-BODY_START = 1.
LS_OBJPACK-BODY_NUM = LV_LINES_TXT.
LS_OBJPACK-DOC_TYPE = 'RAW'.
APPEND LS_OBJPACK TO LT_OBJPACK.

CLEAR:LV_LINES_BIN.
LS_OBJPACK-TRANSF_BIN = 'X'.
LS_OBJPACK-HEAD_START = 1.
LS_OBJPACK-HEAD_NUM = 1.
LS_OBJPACK-BODY_START = 1.

LV_LINES_BIN = LINES( LT_OBJBIN ).

LS_OBJPACK-DOC_SIZE = LV_SIZE .
LS_OBJPACK-BODY_NUM = LV_LINES_BIN.
LS_OBJPACK-DOC_TYPE = 'XLS'.
*LS_OBJPACK-DOC_TYPE = 'XLSX'.
LS_OBJPACK-OBJ_DESCR = LV_FILENAME.
APPEND LS_OBJPACK TO LT_OBJPACK.

LT_RECLIST = VALUE #( FOR LW_RECEIVER IN LT_RECEIVER
                      ( RECEIVER = LW_RECEIVER  " 收件人邮箱
                        REC_TYPE = 'U' ) ).

CALL FUNCTION 'SO_NEW_DOCUMENT_ATT_SEND_API1'
  EXPORTING
    DOCUMENT_DATA              = LS_DOC_CHNG  " 邮件属性
    PUT_IN_OUTBOX              = ''
    COMMIT_WORK                = 'X'
  TABLES
    PACKING_LIST               = LT_OBJPACK  " 邮件内容
    CONTENTS_BIN               = LT_OBJBIN   " 附件内容（二进制）
    CONTENTS_TXT               = LT_OBJTXT   " 邮件内容（直接填入）
    RECEIVERS                  = LT_RECLIST  " 收件箱地址
  EXCEPTIONS
    TOO_MANY_RECEIVERS         = 1
    DOCUMENT_NOT_SENT          = 2
    DOCUMENT_TYPE_NOT_EXIST    = 3
    OPERATION_NO_AUTHORIZATION = 4
    PARAMETER_ERROR            = 5
    X_ERROR                    = 6
    ENQUEUE_ERROR              = 7
    OTHERS                     = 8.

IF SY-SUBRC = 0.
*    es_return-type = 'S'.
*    es_return-message = es_return-message && TEXT-m19. " 邮件发送成功
  WAIT UP TO 1 SECONDS.
  " 立即发送邮件
  SUBMIT RSCONN01                                        "#EC CI_SUBMIT
  WITH MODE = 'INT' WITH OUTPUT = '' AND RETURN. ".
*  WITH MODE = 'INT' AND RETURN. ".
ELSE.
*    es_return-type = 'S'.
*    es_return-message = es_return-message && TEXT-m20. " 邮件发送失败
ENDIF.



*
*
*DATA: IT_DOCUMENT_DATA TYPE SODOCCHGI1,
*      IT_CONTENT_TEXT  TYPE STANDARD TABLE OF SOLISTI1 WITH HEADER LINE,
*      IT_PACKING_LIST  TYPE TABLE OF SOPCKLSTI1 WITH HEADER LINE,
*      IT_RECEIVERS     TYPE STANDARD TABLE OF SOMLRECI1 WITH HEADER LINE,
*      LC_MAIL_ATTACH   TYPE STRING,
*      LT_CONTENT_HEX   TYPE STANDARD TABLE OF SOLIX WITH HEADER LINE,
*      LT_OBJECT_HEADER TYPE STANDARD TABLE OF SOLISTI1 WITH HEADER LINE,
*      LC_MAIL_XATTACH  TYPE XSTRING,
*      LV_SEND_ALL      TYPE C,
*      IT_MAKT          LIKE TABLE OF MAKT WITH HEADER LINE,
*      FIR_DATE         TYPE SY-DATUM,
*      MIMETYPE         TYPE CHAR64.
*DATA: IT_ITAB TYPE TABLE OF ITAB WITH HEADER LINE,
*      WA_ITAB TYPE ITAB.
*
*CONSTANTS:LC_TAB  TYPE C VALUE CL_BCS_CONVERT=>GC_TAB,       "excel换格符
*          LC_CTRL TYPE C VALUE CL_BCS_CONVERT=>GC_CRLF.      "excel换行符
*
*PARAMETERS P_FLAG  TYPE C AS CHECKBOX.
*
*IF P_FLAG = 'X'.
*  PERFORM SEND_EMAIL.
*ENDIF.
*
**&---------------------------------------------------------------------*
**&      Form  SEND_EMAIL
**&---------------------------------------------------------------------*
**       text
**----------------------------------------------------------------------*
*FORM SEND_EMAIL.
*  DATA SY_VLINE TYPE I.
*  DATA:MBLNR TYPE STRING,   "物料凭证
*       MATNR TYPE STRING,   "物料
*       MJAHR TYPE STRING,   "年度
*       MAKTX TYPE STRING.   "物料描述
*
*  IT_DOCUMENT_DATA-OBJ_DESCR = '邮件主题' .    "内容的简短描述
*  IT_DOCUMENT_DATA-PRIORITY = '1'.             "优先次序  1~9  1：最高优先权
*  IT_DOCUMENT_DATA-OBJ_NAME = 'OFFER'.
*  IT_DOCUMENT_DATA-OBJ_LANGU = SY-LANGU.
*
**  ****邮件正文信息
*  IT_CONTENT_TEXT = '各位好：'.
*  APPEND IT_CONTENT_TEXT.
*  IT_CONTENT_TEXT = '  此邮件为测试邮件！！！！！！！'.
*  APPEND IT_CONTENT_TEXT.
*
*  DESCRIBE TABLE IT_CONTENT_TEXT LINES SY_VLINE.
*  IT_DOCUMENT_DATA-DOC_SIZE = 255 * ( SY_VLINE - 1 ) + STRLEN( IT_CONTENT_TEXT ).  "SAPoffice 文档的大小（用于 API1）
*
*  IT_PACKING_LIST-TRANSF_BIN = SPACE.
*  IT_PACKING_LIST-HEAD_START = 1.
*  IT_PACKING_LIST-HEAD_NUM = 0 .
*  IT_PACKING_LIST-BODY_NUM = SY_VLINE.
*  IT_PACKING_LIST-BODY_START = 1.
*  IT_PACKING_LIST-DOC_TYPE = 'RAW'.
*  APPEND IT_PACKING_LIST.
*
*
****收件人信息
**  it_receivers-receiver = '收件人邮箱'.  "收件人地址
*  IT_RECEIVERS-RECEIVER = 'bin.xu@123systems.com'.  "收件人地址
*  IT_RECEIVERS-REC_TYPE = 'U'.
*  IT_RECEIVERS-COM_TYPE = 'INT'.
*  IT_RECEIVERS-NOTIF_DEL =  'X'.
*  IT_RECEIVERS-NOTIF_NDEL = 'X'.
*  APPEND IT_RECEIVERS.
*
*  CONCATENATE '物料'     LC_TAB
*              '物料凭证' LC_TAB
*              '物料描述' LC_TAB
*              '年度'     LC_CTRL INTO LC_MAIL_ATTACH.   "lc_ctrl换行符
*
*  CLEAR:MBLNR, MATNR, MJAHR, MAKTX.
*  MBLNR  = '7777777'.
*  MATNR  = '7777777'.
*  MJAHR  = '7777'.
*  MAKTX  = 'seven'."物料类型
*
*  CONCATENATE LC_MAIL_ATTACH
*              MATNR  LC_TAB
*              MBLNR  LC_TAB
*              MJAHR  LC_TAB
*              MAKTX  LC_CTRL INTO LC_MAIL_ATTACH.      "lc_ctrl换行符
*
*  CLEAR:MBLNR, MATNR, MJAHR, MAKTX.
*  MBLNR  = '8888888'.
*  MATNR  = '8888888'.
*  MJAHR  = '8888'.
*  MAKTX  = 'seven'."物料类型
*
*  CONCATENATE LC_MAIL_ATTACH
*              MATNR  LC_TAB
*              MBLNR  LC_TAB
*              MJAHR  LC_TAB
*              MAKTX  LC_CTRL INTO LC_MAIL_ATTACH.      "lc_ctrl换行符
*
*  MIMETYPE = 'APPLICATION/MSEXCEL;CHARSET=UTF-16LE'.
*  CALL FUNCTION 'SCMS_STRING_TO_XSTRING'
*    EXPORTING
*      TEXT     = LC_MAIL_ATTACH
*      MIMETYPE = MIMETYPE
**     ENCODING =
*    IMPORTING
*      BUFFER   = LC_MAIL_XATTACH
*    EXCEPTIONS
*      FAILED   = 1
*      OTHERS   = 2.
*
*  IF SY-SUBRC = 0.
*    CONCATENATE CL_ABAP_CHAR_UTILITIES=>BYTE_ORDER_MARK_LITTLE LC_MAIL_XATTACH INTO LC_MAIL_XATTACH IN BYTE MODE.
*  ENDIF.
*
*  CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
*    EXPORTING
*      BUFFER     = LC_MAIL_XATTACH
**     APPEND_TO_TABLE  = ' '
**  IMPORTING
**     OUTPUT_LENGTH    =
*    TABLES
*      BINARY_TAB = LT_CONTENT_HEX.
*
*  "不知道干啥用的
*  LT_OBJECT_HEADER = 'Seven test'.
*  APPEND LT_OBJECT_HEADER.
*
*  DESCRIBE TABLE LT_CONTENT_HEX LINES SY_VLINE.
*
*  IT_PACKING_LIST-TRANSF_BIN = 'X'.
*  IT_PACKING_LIST-HEAD_START = 1 .
*  IT_PACKING_LIST-HEAD_NUM =  0 .
*  IT_PACKING_LIST-BODY_START = 1.
*  IT_PACKING_LIST-BODY_NUM = SY_VLINE.
*  IT_PACKING_LIST-DOC_TYPE = 'XLS'.
*  IT_PACKING_LIST-DOC_SIZE = 255 * SY_VLINE.
*  IT_PACKING_LIST-OBJ_NAME = '附件名'.
*  IT_PACKING_LIST-OBJ_DESCR = IT_PACKING_LIST-OBJ_NAME.
*  APPEND IT_PACKING_LIST.
*
*
*  "方法1  无法指定发送人邮箱
********  CALL FUNCTION 'SO_NEW_DOCUMENT_ATT_SEND_API1'
********    EXPORTING
********      document_data              = it_document_data
********      put_in_outbox              = 'X'
********      commit_work                = 'X'
********    IMPORTING
********      sent_to_all                = lv_send_all
*********       NEW_OBJECT_ID              =
********    TABLES
********      packing_list               = it_packing_list[]
********      object_header              = lt_object_header[]
*********     contents_bin               =
********      contents_txt               = it_content_text[]
********      contents_hex               = lt_content_hex[]
*********     object_para                =
*********     object_parb                =
********      receivers                  = it_receivers[]
********    EXCEPTIONS
********      too_many_receivers         = 1
********      document_not_sent          = 2
********      document_type_not_exist    = 3
********      operation_no_authorization = 4
********      parameter_error            = 5
********      x_error                    = 6
********      enqueue_error              = 7
********      others                     = 8 .
*
*  "方法2  可以指定发送人邮箱
*  CALL FUNCTION 'SO_DOCUMENT_SEND_API1'
*    EXPORTING
*      DOCUMENT_DATA              = IT_DOCUMENT_DATA
*      PUT_IN_OUTBOX              = 'X'
*      SENDER_ADDRESS             = '504077806@qq.com'
*      SENDER_ADDRESS_TYPE        = 'INT'
*      COMMIT_WORK                = 'X'
**     IP_ENCRYPT                 =
**     IP_SIGN                    =
**     IV_VSI_PROFILE             =
*    IMPORTING
*      SENT_TO_ALL                = LV_SEND_ALL
**     NEW_OBJECT_ID              =
**     SENDER_ID                  =
*    TABLES
*      PACKING_LIST               = IT_PACKING_LIST[]
*      OBJECT_HEADER              = LT_OBJECT_HEADER[]
**     CONTENTS_BIN               =
*      CONTENTS_TXT               = IT_CONTENT_TEXT[]
*      CONTENTS_HEX               = LT_CONTENT_HEX[]
**     OBJECT_PARA                =
**     OBJECT_PARB                =
*      RECEIVERS                  = IT_RECEIVERS[]
**     ET_VSI_ERROR               =
*    EXCEPTIONS
*      TOO_MANY_RECEIVERS         = 1
*      DOCUMENT_NOT_SENT          = 2
*      DOCUMENT_TYPE_NOT_EXIST    = 3
*      OPERATION_NO_AUTHORIZATION = 4
*      PARAMETER_ERROR            = 5
*      X_ERROR                    = 6
*      ENQUEUE_ERROR              = 7
*      OTHERS                     = 8.
*  IF SY-SUBRC <> 0.
**   Implement suitable error handling here
*  ELSE.
*    SUBMIT RSCONN01 WITH MODE = 'INT'
*                   WITH OUTPUT = 'X'
*                   AND RETURN.
*  ENDIF.
*
*ENDFORM.                    "SEND_EMAIL
```
## 参考资料
[SAP SMTP郵件服務器配置 發送端 QQ郵箱 ](https://www.cnblogs.com/jxzhu/p/11957516.html)
[ABAP 发送带EXCEL邮件-Seele_1018](https://blog.csdn.net/qq_44826887/article/details/136294662?spm=1001.2014.3001.5502)
[ABAP-发送PDF附件邮件-LiXiangChen](https://www.cnblogs.com/lixiangchen/p/17798077.html)